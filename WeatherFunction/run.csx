using System;
using System.Net;

private static readonly string Ratingen = "707860, 519188, 1283378, 1270260, 708546, 1283710, 529334, 1269750, 1283240, 703363, 3632308, 473537, 384848, 569143, 713514, 2878044, 464176, 295582, 1271231, 690856, 464737, 707716, 697959, 803611, 614371, 874560, 874652, 2347078, 2051302, 563692, 481725, 2638976, 2892705, 2922336, 975511, 1280737, 745042, 3496831, 2017370, 2045761, 1257986, 476350, 1343000, 456169, 475279, 711349, 798544, 3094325, 6255149, 3575514, 1861387, 1857578, 1299298, 3256023, 2921044, 2861876, 802899, 523523, 546448, 500023, 2207349, 7870412, 961935, 3371200, 1016666, 3858204, 4070245, 4344544, 4215307, 5285039, 4673179, 6078447, 2201316, 1938756, 2009359, 2566086, 154733, 1630349, 2224928, 6716279, 2384618, 378867, 2230362, 343846, 370366, 365618, 524894, 1861060, 2130037, 6199126, 6388445, 494806, 467104, 462352, 2267057, 3082707, 3091150, 1784658, 7301040, 1348747, 6255148, 524925, 4047656, 5493998, 1463749, 749184, 750594, 3113208, 2653753, 658226, 2744819, 3017680, 448961, 3007202, 2650353, 2058430, 2181258, 2130135, 2110681, 1862845, 1863250, 1852699, 1853163, 1864427, 1861816, 1857451, 2128894, 3175936, 6539582, 6542288, 6540662, 3333225, 7290647, 7291924, 2649140, 2647062, 2648355, 2636001, 510291, 518858, 3746183, 1014012, 3579132, 1790413, 1850144, 5815135, 5391891, 148251, 141668, 66108,", 2410048, 1092342, 3719432, 6538016, 3428577, 7871309, 7839407, 147059, 147425, 148340, 2784549, 2793079, 2795101, 2354349, 6930703, 3901501, 6050612, 203717, 204283, 204318, 210379, 210939, 211098, 214575, 215527, 215605, 217637, 2311968, 2312249, 2313084, 2314300, 7286409, 6295429, 7286907, 6291739, 6295642, 2280376, 2221394, 3072342, 3064531, 6547426, 6553084, 2835344, 7602475, 6553078, 6553081, 2915013, 6553073, 6553056, 6557629, 2820086, 6553128, 6556314, 2916630, 6553174, 6553072, 6555618, 6553040, 2957818, 3221125, 2949188, 6555717, 6552854, 6557561, 6553094, 2856307, 7602483, 6543938, 2616011, 2618525, 3495858, 3496332, 2476412, 2479183, 2482939, 2483761, 2487620, 2498775, 6361023, 6361010, 6359459, 6358465, 6362958, 6356273, 6359334, 6533993, 6534092, 6359320, 6359308, 6356141, 6359300, 6362203, 6357300, 6361741, 6356206, 6362379, 6358120, 6362372, 6359273, 6359266, 6356068, 6359026, 6356985, 6360635, 3128528, 6357735, 329586, 331180, 332880, 2204582, 7626930, 6441676, 6438569, 6454050, 6446231, 6452039, 6453748, 6446218, 6457368, 6425695, 6438526, 6446342, 6446340, 6438498, 6451981, 6427088, 6455342, 6441760, 6454369, 6454153, 6454341, 6454014, 6446184, 6443784, 6441724, 6446721, 6446177, 6430140, 6453858, 6452024, 6430468, 6452023, 6457185, 6432528, 6446146, 6446274, 6454157, 6451993, 6455107, 6433192, 6441821, 6455404, 6455339, 6453697, 6428545, 6443604, 6618272, 3028097, 6439436" ;

private static readonly string AppKey = "bbf5fb8c8b5733365893886826af5724";

public static void Run(TimerInfo myTimer, out string outputEventHubMessage, TraceWriter log)
{
    log.Info($"C# time triggered function called with pattern: {myTimer.Schedule} at {DateTime.Now}");
    log.Info(myTimer.FormatNextOccurrences(3));
    
    // building URL
    UriBuilder ub = new UriBuilder();
    ub.Host = "api.openweathermap.org";
    ub.Path = "data/2.5/group";
    ub.Scheme = "http";
    ub.Query = string.Format("appid={0}&id={1}", AppKey, Ratingen);

    // do the GET
    HttpWebRequest request = (HttpWebRequest)WebRequest.Create(ub.Uri);
    request.Method = "GET";
    WebResponse wr = request.GetResponse();

    // read response
    Stream ws =  wr.GetResponseStream();
    StreamReader reader = new StreamReader(ws);
    string json = reader.ReadToEnd();
    log.Info(json);
    
    // send message
    outputEventHubMessage = json;
            
            
    // close objects
    wr.Close();
    reader.Close();
    ws.Dispose();    
}